pos_seqs <- read_uniprot(paste0(pathway, "sept_signal.txt"), euk = TRUE)
neg_seqs <- read.fasta(paste0(pathway, "sept_neg.fasta"), seqtype = "AA")
#remove sequences with atypical aminoacids
atyp_aa <- which(sapply(neg_seqs, function(i) any(i %in% c("X", "J", "Z", "B", "U"))))
too_short <- which(sapply(neg_seqs, length) < 80)
neg_seqs <- neg_seqs[-unique(c(atyp_aa, too_short))]

too_short <- which(sapply(pos_seqs, length) < 80)
pos_seqs <- pos_seqs[-c(too_short)]

pos_ids <- cvFolds(length(pos_seqs), K = 5)
neg_ids <- cvFolds(length(neg_seqs), K = 5)



#cross-validation --------------------------------
#proteins with signal peptides

cl <- makeCluster(4, type = "SOCK")
clusterExport(cl, c("predict.signal.hsmm", "signal.hsmm_decision", "degenerate"))

multifolds_cl_work <- pblapply(1L:100, function(dummy_variable) { 
  pos_ids <- cvFolds(length(pos_seqs), K = 5)
  cv_neg <- neg_seqs[sample(1L:length(neg_seqs), length(pos_seqs))]
  
  fold_res <- lapply(1L:5, function(fold) {
    model_cv <- hsmm(pos_seqs[pos_ids[[4]][,][pos_ids[[5]] == fold]], aaaggregation)
    test_dat <- c(pos_seqs[pos_ids[[4]][,][pos_ids[[5]] != fold]],
                  cv_neg[pos_ids[[4]][,][pos_ids[[5]] != fold]])
    
    #cleavege site prediction - extract cleave data
    cleave_train <- do.call(rbind, lapply(pos_seqs[pos_ids[[4]][,][pos_ids[[5]] == fold]], 
                                          function(seq) {
      cleave_site <- attr(seq, "sig")[2]
      cs <- seq[(cleave_site-4):(cleave_site+3)]
      pre_cs <- if(cleave_site > 12) {
        seq[(cleave_site - 12):(cleave_site - 5)]
      } else {
        rep(NA, 8)
      }
      post_cs <- seq[(cleave_site + 6):(cleave_site + 13)]
      matrix(c(cs, pre_cs, post_cs), nrow = 3, byrow = TRUE)
    }))
    #degenerate potential cleavage sites
    cleave_train <- t(apply(cleave_train, 1, function(i)
      if(any(is.na(i))) {
        i
      } else {
        degenerate(i, aaaggregation)
      }))
    #create etiquettes
    cleave_train_ets <- rep(c(1, 0, 0), nrow(cleave_train)/3)
    #eliminate NAs generated by too short signal peptides
    na_cases <- which(is.na(cleave_train[, 1]))
    if (length(na_cases) > 0) {
      cleave_train <- cleave_train[-na_cases, ]
      cleave_train_ets <- cleave_train_ets[-na_cases]
    }
    cleave_train_ets_f <- factor(cleave_train_ets)
    levels(cleave_train_ets_f) <- c("neg", "pos")
    cleave_train_grams <- cbind(count_ngrams(cleave_train, 1, 1L:4, pos = TRUE),
                                count_ngrams(cleave_train, 2, 1L:4, pos = TRUE))
    #extract important features
    all_tested <- test_features(cleave_train_ets, cleave_train_grams)
    imp_features <- cut(all_tested, breaks = c(0, 1e-03, 1))[[1]]
    rf_train <- data.frame(as.matrix(cleave_train_grams[, imp_features]),
                           tar = cleave_train_ets_f)
    #train RF
    rf_model <- randomForest(tar ~ ., data = rf_train)
    
    #hsmm_preds <- parLapply(cl, c(1L:50, 4500:4550), function(protein_id) try({
    #clusterExport(cl, c("model_cv", "test_dat"), environment())
    #hsmm_preds <- lapply(1L:length(test_dat), function(protein_id) try({
    #hsmm_preds <- lapply(1L:length(test_dat), function(protein_id) try({
    hsmm_preds <- parLapply(cl, 1L:length(test_dat), function(protein_id) try({
      library(signal.hsmm)
      unlist(predict.signal.hsmm(model_cv, test_dat[[protein_id]])[[1]][c("sp_probability", "sp_end")])
    }, silent = TRUE))
    
    t(sapply(1L:length(hsmm_preds), function(protein_id)
      c(if(class(hsmm_preds[[protein_id]]) == "try-error") {
        c(NA, NA, NA)
      } else {
        hsmm_end <- hsmm_preds[[protein_id]][["sp_end"]]
        pred_start <- ifelse(hsmm_end > 9, hsmm_end - 9, 2)
        deg_subseq <- degenerate(test_dat[[protein_id]][(pred_start):(pred_start + 20)],
                                 aaaggregation)
        deg_subseqs <- t(sapply(1L:21, function(subseq_start) 
          deg_subseq[subseq_start:(subseq_start + 7)]))
        
        cleave_test_grams <- cbind(count_ngrams(deg_subseqs, 1, 1L:4, pos = TRUE),
                                   count_ngrams(deg_subseqs, 2, 1L:4, pos = TRUE))
        rf_end <- hsmm_end - 9 + which.max(predict(rf_model,
                                                   data.frame(as.matrix(cleave_test_grams[, imp_features])),
                                                   type = "prob")[, 2])
        
        c(hsmm_preds[[protein_id]], rf_end = rf_end, real = ifelse(is.null(attr(test_dat[[protein_id]], "sig")[2]),
                                                                   NA, attr(test_dat[[protein_id]], "sig")[2]))
      })))
  })
})

stopCluster(cl)

save(multifolds_cl_work, file = "cleave_pred20.RData")

